<?xml version="1.0" encoding="UTF-8"?>
<!--###################################################################################
		Lake of Constance Hangar :: M.Kraus
		Motorcycles for Flightgear December 2016
		This file is licenced under the terms of the GNU General Public Licence V2 or later
		###################################################################################
-->
<PropertyList>

  <name>analysis</name>
  <modal>false</modal>
  <layout>vbox</layout>
  <padding>20</padding>
  <pref-width>1024</pref-width>

  <group>
    <layout>hbox</layout>
    <empty>
      <stretch>1</stretch>
    </empty>		
    <text>
      <label>RACELAPS ANALYSIS TOOL</label>
    </text>
    <empty>
      <stretch>1</stretch>
    </empty>
    <button>
      <pref-width>16</pref-width>
      <pref-height>16</pref-height>
      <legend></legend>
      <keynum>27</keynum>
      <border>2</border>
      <binding>
        <command>dialog-close</command>
      </binding>
    </button>
  </group>
  
	<hrule/>
	<group>
	    <layout>hbox</layout>
	    <empty>
	      <stretch>1</stretch>
	    </empty>
      <button>
        <legend>Lap 1</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(1);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 2</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(2);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 3</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(3);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 4</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(4);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 5</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(5);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 6</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(6);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 7</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(7);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 8</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(8);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 9</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(9);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 10</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(10);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 11</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(11);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 12</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(12);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 13</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(13);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>

      <button>
        <legend>Lap 14</legend>
        <default>false</default>
		<binding>
			<command>nasal</command>
			<script>motorcycle.set_analysis_lap(14);</script>
		</binding>
          <binding>
              <command>nasal</command>
              <script>settimer(func{motorcycle.analysis_dlg.open()},0.25)</script>
          </binding>
	    <binding>
	      <command>dialog-close</command>
	    </binding>
      </button>
	</group>  

	<canvas>
		<name>analysis_toolbox</name>
		<valign>fill</valign>
		<halign>fill</halign>
		<stretch>true</stretch>
		<pref-width>1000</pref-width>
		<pref-height>380</pref-height>
		<nasal>      
			<load>
			<![CDATA[
				# you can add your canvas-specific code here
				var alll = props.globals.getNode("/instrumentation/Motorcycle/blackbox");
				var berechnungszahl = 0.0;
				var my_canvas = canvas.get( cmdarg() ); # this will get a handle to the parent canvas:
				#my_canvas.setColorBackground(0.9,0.9,0.9,0.9);

				var root = my_canvas.createGroup();

				var graph = root.createChild("group");

				var x_axis = graph.createChild("path", "x-axis")
				               .moveTo(30, 400)
				               .lineTo(980, 400)
				       		   .setColor(0.5,0.5,0.5)
				       		   .setStrokeLineWidth(2);

				var y_axis = graph.createChild("path", "y-axis")
				               .moveTo(30, 30)
				               .lineTo(30, 400)
				       		   .setColor(0.5,0.5,0.5)
				       		   .setStrokeLineWidth(2);

				var n = 1;
				var ncolor1 = 0.0;
				var ncolor2 = 0.0;
				var ncolor3 = 0.0;
				if(getprop("Motorcycle/race-lap")>=1){
					berechnungszahl = size(alll.getChild("lap",1).getChildren("lapstep"))-1;
					berechnungszahl = 940/berechnungszahl;
				}
				

		   		foreach(var l;alll.getChildren("lap")){
				
					ncolor1 += 0.2;
					ncolor2 += 0.25;
					ncolor3 += 0.5;

					ncolor1 = (ncolor1 >= 1.0)? 0.0 : ncolor1;
					ncolor2 = (ncolor2 >= 1.0)? 0.0 : ncolor2;
					ncolor3 = (ncolor3 >= 1.0)? 0.0 : ncolor3;
				
					var test = alll.getChild("lap",n);
					if(test.getValue("selected")){
						var text = root.createChild("text")
					            .setText(n~".Lap")
					            .setTranslation(45*n, 10)
					            .setAlignment("left-top")
					            .setFontSize(14)
					            .setFont("LiberationFonts/LiberationSans-Regular.ttf")
					            .set("max-width", 980)
					            .setColor(ncolor1,ncolor2,ncolor3);

						var samples = [];
						var zeitleiste = 40;
						var firstspeed = 0;

						firstspeed = getprop("instrumentation/Motorcycle/blackbox/lap["~n~"]/lapstep[1]/speed") or 0;
						firstspeed = 400-firstspeed/1.2;

						var al = size(l.getChildren("lapstep"));
			
						for (var i=2; i < al; i+=1) {
							var splt = getprop("instrumentation/Motorcycle/blackbox/lap["~n~"]/lapstep["~i~"]/speed") or 0;
							var spee = 400-splt/1.2;
							zeitleiste+=berechnungszahl;
							append(samples,[zeitleiste,spee]);
						}

			            var plot = graph.createChild("path", "data")
			                            .setStrokeLineWidth(2)
			                            .setColor(ncolor1,ncolor2,ncolor3)
			                            .moveTo(30,firstspeed); # origin  
			
			            foreach(var set; samples) {
			                   plot.lineTo( set[0], set[1]);
			            }
					}

		            n+=1;			

		    	}

			]]>
			</load>
		</nasal>
	</canvas>

 
  
  <button>
    <legend>Close</legend>
    <default>true</default>
    <key>Esc</key>
    <binding>
      <command>dialog-apply</command>
    </binding>
    <binding>
      <command>dialog-close</command>
    </binding>
  </button>
  
  <nasal>
    <open></open>
  </nasal>
</PropertyList>
